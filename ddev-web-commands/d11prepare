#!/bin/bash

# Usage: d11prepare
# Example: ddev d11prepare
# Description: Updates packages, themes, files, and cleanup:
#  1. Conditional project type updates
#  2. Core version requirement for theme
#  3. Update recipes location and removal from prior location
#  4. Remove cypress and supporting files if conditions met
#  5. Removes lando and audit files
#  6. Global dependency updates
#  7. Update database
#  8. Install upgrade_status


# --- Update based on Project Type selected ---
## Set up the update options
run_updates() {
    echo "Choose a project type:"
    OPTIONS=("Custom" "VPR" "Science" "APSC" "Exit")

    select OPT in "${OPTIONS[@]}"; do
        case $REPLY in
            1)
                echo "âœ… Updating custom modules..."
                composer require ubc-web-services/kraken ubc-web-services/ubc_add_to_calendar ubc-web-services/ubc_chosen_style_tweaks ubc-web-services/ubc_ckeditor_widgets ubc-web-services/ubc_d8_config_modules
                break
                ;;
            2)
                echo "âœ… Updating custom VPR modules..."
                composer require ubc-web-services/kraken-vpr:dev-master ubc-web-services/ubc_add_to_calendar ubc-web-services/ubc_chosen_style_tweaks ubc-web-services/ubc_ckeditor_widgets ubc-web-services/ubc_d8_config_modules
                INFO_FILE="web/themes/custom/vpr/vpr.info.yml"
                break
                ;;
            3)
                echo "âœ… Updating custom Science modules..."
                composer require ubc-web-services/kraken-science ubc-web-services/ubc_chosen_style_tweaks ubc-web-services/ubc_ckeditor_widgets ubc-web-services/ubc_d8_config_modules ubc-web-services/ubc_science_shared_config
                INFO_FILE="web/themes/custom/science/science.info.yml"
                break
                ;;
            4)
                echo "âœ… Updating custom APSC modules..."
                composer require ubc-web-services/ubc_chosen_style_tweaks ubc-web-services/ubc_ckeditor_widgets ubc-web-services/ubc_d8_config_modules
                INFO_FILE="web/themes/custom/kraken/kraken.info.yml"
                break
                ;;
            5)
                echo "Exiting..."
                exit 0
                ;;
            *)
                echo "âŒ Invalid option. Please try again."
                ;;
        esac
  done
}

## Run updates
run_updates

## Update the core version requirement if we can
if [[ -f "$INFO_FILE" ]]; then
    sed -i '' "/^core_version_requirement:/{
        s/.*/core_version_requirement: '>=10'/
    }" "$INFO_FILE"
    echo "Core version requirement update was attempted"
else
  echo "âŒ Please update the core_version_requirement value in the .info file manually. Correct value: '>=10'."
fi


# --- Recipes ---
COMPOSER_FILE="composer.json"
TMP_FILE=$(mktemp)
## Check if jq is installed
if ! command -v jq &> /dev/null; then
    echo "âŒ jq is not installed."
    echo "Please install jq and run this again."
    exit 1
fi

## Check if the composer file exists
if [[ ! -f "$COMPOSER_FILE" ]]; then
    echo "âŒ composer.json not found"
    exit 1
fi

## Fix web/recipes keys in composer file
jq '
  if .extra["installer-paths"] != null then
    .extra["installer-paths"] |= with_entries(
      if .key | test("^web/recipes/") then
        .key |= sub("^web/recipes/"; "recipes/")
      else
        .
      end
    )
  else
    .
  end
' "$COMPOSER_FILE" > "$TMP_FILE" && mv "$TMP_FILE" "$COMPOSER_FILE"

echo "âœ… Updated installer-path keys from web/recipes/* â†’ recipes/*."

## Delete old web/recipes directory if it exists
RECIPES_DIR="web/recipes"

if [[ -d "$RECIPES_DIR" ]]; then
    echo "ðŸ—‘ï¸  Found $RECIPES_DIR â€” deleting..."
    rm -rf "$RECIPES_DIR"
    echo "âœ… Deleted old $RECIPES_DIR."
else
    echo "â„¹ï¸  No $RECIPES_DIR directory found. Skipping."
fi

## Update .gitignore if it has /web/recipes/
if [[ -f ".gitignore" ]]; then
    if grep -q "^/web/recipes/" .gitignore; then
        sed -i.bak 's#^/web/recipes/#/recipes/#' .gitignore
        rm -f .gitignore.bak
        echo "âœ… Updated .gitignore entries from /web/recipes/ â†’ /recipes/"
    else
        echo "â„¹ï¸  No /web/recipes/ entries found in .gitignore"
    fi
else
    echo "â„¹ï¸  No .gitignore file found, skipping"
fi


# --- Simplesamlphp ---
## Delete the simplesamlphp directory if CWL modules are not in the composer required modules
SIMPLESAML_DIR="simplesamlphp"
if [[ -f "$COMPOSER_FILE" ]]; then
    # Check for either module inside "require"
    HAS_UBC=$(jq -r '.require["ubc-web-services/ubc_saml_auth10"] // empty' "$COMPOSER_FILE")
    HAS_SSP=$(jq -r '.require["simplesamlphp/simplesamlphp"] // empty' "$COMPOSER_FILE")
    HAS_UCA=$(jq -r '.require["ubc-web-services/ubc_cwl_auth"] // empty' "$COMPOSER_FILE")

    if [[ -z "$HAS_UBC" && -z "$HAS_SSP" && -z "$HAS_UCA" ]]; then
        echo "âŒ Required SAML modules not found in composer.json"

        if [[ -d "$SIMPLESAML_DIR" ]]; then
            echo "ðŸ—‘ï¸  Deleting $SIMPLESAML_DIR directory..."
            rm -rf "$SIMPLESAML_DIR"
            echo "âœ… Directory deleted."
        else
            echo "â„¹ï¸ Directory $SIMPLESAML_DIR does not exist â€” nothing to delete."
        fi
    else
        echo "âœ… SAML module found in composer.json â€” keeping directory."
    fi
else
    echo "âš ï¸ composer.json not found â€” skipping SAML check."
fi


# --- Clean up outdated dependencies ---
## Ensure package.json exists
if [[ ! -f "package.json" ]]; then
  echo "â„¹ï¸ package.json not found. Skipping Cypress cleanup."
else
    # Extract devDependencies keys using jq
    if command -v jq >/dev/null 2>&1; then
        DEV_KEYS=$(jq -r '.devDependencies | keys[]?' package.json)
    else
        # Fallback if jq is not installed
        DEV_KEYS=$(grep -o '"devDependencies": {[^}]*}' -A50 package.json \
          | sed -n 's/.*"devDependencies": {//p; /}/q' \
          | grep -o '"[^"]*"' \
          | sed 's/"//g')
    fi

    # Count how many devDependencies exist
    COUNT=$(echo "$DEV_KEYS" | sed '/^$/d' | wc -l | tr -d ' ')

    # Check if Cypress is the only devDependency
    if [[ "$COUNT" -eq 1 && "$DEV_KEYS" == "cypress" ]]; then
        echo "ðŸ§¹ Cypress is the only devDependency â€” cleaning up..."

        rm -f package.json
        rm -f package-lock.json
        rm -f cypress.json

        if [[ -d "cypress" ]]; then
            rm -rf cypress
        fi

        echo "âœ… Cleanup completed."
    else
        echo "â„¹ï¸ Other devDependencies found â€” leaving project files intact."
        echo "   devDependencies found: $DEV_KEYS"
    fi
fi

## Remove audit.sh if it exists
if [[ -f "audit.sh" ]]; then
    rm -f audit.sh
    echo "âœ… Removed audit.sh file"
else
    echo "â„¹ï¸  No audit.sh file found, skipping"
fi

## Remove project_summary.md if it exists
if [[ -f "project_summary.md" ]]; then
    rm -f project_summary.md
    echo "âœ… Removed project_summary.md file"
else
    echo "â„¹ï¸  No project_summary.md file found, skipping"
fi

## Remove .lando file
rm -f .lando.yml
rm -f landoquickstart.sh
rm -f LICENSE


# --- Update / Add dependencies ---
composer require 'drush/drush' 'drupal/formtips:^1.11||^2.0' 'drupal/upgrade_status' 'drupal/webform:^6.3@beta' 'drupal/ckeditor5_plugin_pack' 'drupal/linkit:7.0.10' 'drupal/linkit_media_library:^2.0' 'drupal/image_widget_crop:^3.0' 'drupal/file_delete:^3.0' 'drupal/gin:^4.1||^5.0' 'drupal/gin_toolbar:^2.1||^3.0' 'ubc-web-services/ws-recipes:dev-ddev' 'drupal/ckeditor5_fullscreen'

## Check for drupal/editor_advanced_link and pin to version 2.3.1
ADVLINK="drupal/editor_advanced_link"
TARGET_VERSION="2.3.1"

echo "Checking for $ADVLINK..."

## Look to see if the module is declared in packages
if composer show --locked | grep -q "^$ADVLINK "; then
    echo "âœ… $ADVLINK is installed. Updating to version $TARGET_VERSION..."
    composer require "$ADVLINK:$TARGET_VERSION"
else
    echo "â„¹ï¸  $ADVLINK is not installed. Skipping."
fi

# Run the bookmark button recipe (must be run from web root)
cd ${DDEV_DOCROOT}
php core/scripts/drupal recipe ../recipes/ws-recipes/ws-utility/utility-add-bookmark-button -v

## Run any database updates
drush updb -y

## Enable Upgrade Status module
drush pm:enable upgrade_status


# --- End ---
echo "All done - you should check that the core_version_requirement in the active [theme].info.yml is set to: core_version_requirement: '>=10'."